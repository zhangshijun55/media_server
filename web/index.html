<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Server</title>
    <script src="https://cdn.jsdelivr.net/npm/mpegts.js@1.7.3/dist/mpegts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            height: 100vh;
            display: flex;
        }

        /* Left Sidebar */
        .sidebar {
            width: 200px;
            background-color: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            padding-top: 20px;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid #34495e;
            margin-bottom: 10px;
        }

        .sidebar-header h2 {
            font-size: 18px;
            font-weight: 600;
        }

        /* Language Switcher */
        .lang-switcher {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .lang-btn {
            padding: 4px 8px;
            font-size: 12px;
            border: 1px solid #4a5568;
            background: transparent;
            color: #a0aec0;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .lang-btn:hover {
            background-color: #4a5568;
            color: white;
        }

        .lang-btn.active {
            background-color: #3498db;
            border-color: #3498db;
            color: white;
        }

        .nav-item {
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background-color 0.3s;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background-color: #34495e;
        }

        .nav-item.active {
            background-color: #3498db;
            border-left-color: #fff;
        }

        .nav-item svg {
            width: 20px;
            height: 20px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow: auto;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .content-header h1 {
            font-size: 24px;
            color: #2c3e50;
        }

        .refresh-btn {
            padding: 8px 16px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.3s;
        }

        .refresh-btn:hover {
            background-color: #2980b9;
        }

        .upload-btn {
            padding: 8px 16px;
            background-color: #27ae60;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.3s;
            margin-right: 10px;
        }

        .upload-btn:hover {
            background-color: #219a52;
        }

        .add-btn {
            padding: 8px 16px;
            background-color: #9b59b6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.3s;
            margin-right: 10px;
        }

        .add-btn:hover {
            background-color: #8e44ad;
        }

        .catalog-btn {
            padding: 8px 16px;
            background-color: #e67e22;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.3s;
            margin-right: 10px;
        }

        .catalog-btn:hover {
            background-color: #d35400;
        }

        .info-btn {
            padding: 8px 16px;
            background-color: #1abc9c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.3s;
            margin-right: 10px;
        }

        .info-btn:hover {
            background-color: #16a085;
        }

        /* Form Modal */
        .form-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .form-modal.active {
            display: flex;
        }

        .form-container {
            background-color: white;
            border-radius: 8px;
            width: 450px;
            max-width: 90%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: #2c3e50;
            color: white;
            border-radius: 8px 8px 0 0;
        }

        .form-header h3 {
            margin: 0;
            font-size: 18px;
        }

        .form-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #2c3e50;
        }

        .form-group label .required {
            color: #e74c3c;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-footer {
            padding: 15px 20px;
            background-color: #f8f9fa;
            border-radius: 0 0 8px 8px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-cancel {
            padding: 8px 20px;
            background-color: #95a5a6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-cancel:hover {
            background-color: #7f8c8d;
        }

        .btn-submit {
            padding: 8px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-submit:hover {
            background-color: #2980b9;
        }

        .header-buttons {
            display: flex;
            align-items: center;
        }

        #file-upload-input {
            display: none;
        }

        /* Table Styles */
        .data-table {
            width: 100%;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .data-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        .data-table tr:hover {
            background-color: #f8f9fa;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        /* Status Badge */
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-on {
            background-color: #d4edda;
            color: #155724;
        }

        .status-off {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* Loading Spinner */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 50px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Error Message */
        .error-message {
            padding: 20px;
            background-color: #f8d7da;
            color: #721c24;
            border-radius: 8px;
            text-align: center;
        }

        /* Empty State */
        .empty-state {
            padding: 50px;
            text-align: center;
            color: #6c757d;
        }

        .empty-state svg {
            width: 60px;
            height: 60px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Content sections */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* Preview Icon */
        .preview-icon {
            cursor: pointer;
            color: #3498db;
            transition: color 0.3s;
        }

        .preview-icon:hover {
            color: #2980b9;
        }

        /* Delete Icon */
        .delete-icon {
            cursor: pointer;
            color: #e74c3c;
            transition: color 0.3s;
            margin-left: 10px;
        }

        .delete-icon:hover {
            color: #c0392b;
        }

        /* Video Modal */
        .video-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .video-modal.active {
            display: flex;
        }

        .video-container {
            position: relative;
            background-color: #000;
            border-radius: 8px;
            overflow: hidden;
            max-width: 90%;
            max-height: 90%;
        }

        .video-container video {
            width: 800px;
            height: 450px;
            display: block;
        }

        .video-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background-color: #2c3e50;
            color: white;
        }

        .video-header h3 {
            font-size: 16px;
            font-weight: 500;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 24px;
            line-height: 1;
            padding: 0;
        }

        .close-btn:hover {
            color: #e74c3c;
        }

        .video-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
        }

        /* GB Section Tabs */
        .gb-tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }

        .gb-tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 500;
            color: #6c757d;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s;
        }

        .gb-tab:hover {
            color: #3498db;
        }

        .gb-tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }

        .gb-tab-content {
            display: none;
        }

        .gb-tab-content.active {
            display: block;
        }

        /* Search Form Styles */
        .search-form {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .search-form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }

        .search-form-group {
            flex: 1;
            min-width: 150px;
        }

        .search-form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #2c3e50;
            font-size: 13px;
        }

        .search-form-group select,
        .search-form-group input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .search-form-group select:focus,
        .search-form-group input:focus {
            outline: none;
            border-color: #3498db;
        }

        .search-btn {
            padding: 8px 24px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.3s;
            height: fit-content;
        }

        .search-btn:hover {
            background-color: #2980b9;
        }

        .search-btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <!-- Left Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2 data-i18n="mediaServer">Media Server</h2>
            <div class="lang-switcher">
                <button class="lang-btn active" data-lang="en">EN</button>
                <button class="lang-btn" data-lang="zh">中文</button>
            </div>
        </div>
        <div class="nav-item active" data-target="device">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
            <span data-i18n="navDevice">Device</span>
        </div>
        <div class="nav-item" data-target="file">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
            </svg>
            <span data-i18n="navFile">File</span>
        </div>
        <div class="nav-item" data-target="gbdomain">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
            </svg>
            <span data-i18n="navGbDomain">GB Domain</span>
        </div>
        <div class="nav-item" data-target="webrtc">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0" />
            </svg>
            <span data-i18n="navWebrtc">WebRTC</span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Device Section -->
        <div id="device-section" class="content-section active">
            <div class="content-header">
                <h1 data-i18n="deviceList">Device List</h1>
                <div class="header-buttons">
                    <button class="add-btn" onclick="showAddDeviceModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        <span data-i18n="addDevice">Add Device</span>
                    </button>
                    <button class="refresh-btn" onclick="loadDevices()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        <span data-i18n="refresh">Refresh</span>
                    </button>
                </div>
            </div>
            <div id="device-content" class="data-table">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- File Section -->
        <div id="file-section" class="content-section">
            <div class="content-header">
                <h1 data-i18n="fileList">File List</h1>
                <div class="header-buttons">
                    <input type="file" id="file-upload-input"
                        accept="video/*,audio/*,.mkv,.avi,.wmv,.flv,.webm,.mov,.mp4,.m4v,.ts,.m2ts,.mts"
                        onchange="uploadFile(this)">
                    <button class="upload-btn" onclick="document.getElementById('file-upload-input').click()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                        </svg>
                        <span data-i18n="upload">Upload</span>
                    </button>
                    <button class="refresh-btn" onclick="loadFiles()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        <span data-i18n="refresh">Refresh</span>
                    </button>
                </div>
            </div>
            <div id="file-content" class="data-table">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- GB Domain Section -->
        <div id="gbdomain-section" class="content-section">
            <div class="content-header">
                <h1>GB28181</h1>
            </div>

            <!-- GB Tabs -->
            <div class="gb-tabs">
                <button class="gb-tab active" data-gb-target="gb-domain-tab" data-i18n="domainList">Domain List</button>
                <button class="gb-tab" data-gb-target="gb-record-tab" data-i18n="gbRecord">GB Record</button>
            </div>

            <!-- Domain List Tab -->
            <div id="gb-domain-tab" class="gb-tab-content active">
                <div style="display: flex; justify-content: flex-end; margin-bottom: 15px;">
                    <button class="catalog-btn" onclick="syncGbCatalog()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        <span data-i18n="catalog">Catalog</span>
                    </button>
                    <button class="info-btn" onclick="showGbServerInfo()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span data-i18n="serverInfo">Server Info</span>
                    </button>
                    <button class="refresh-btn" onclick="loadGbDomains()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        <span data-i18n="refresh">Refresh</span>
                    </button>
                </div>
                <div id="gbdomain-content" class="data-table">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>

            <!-- GB Record Tab -->
            <div id="gb-record-tab" class="gb-tab-content">
                <div class="search-form">
                    <div class="search-form-row">
                        <div class="search-form-group" style="flex: 2;">
                            <label data-i18n="gbDevice">GB Device</label>
                            <select id="gb-record-device">
                                <option value="" data-i18n="selectDevice">-- Select Device --</option>
                            </select>
                        </div>
                        <div class="search-form-group">
                            <label data-i18n="startTime">Start Time</label>
                            <input type="datetime-local" id="gb-record-start">
                        </div>
                        <div class="search-form-group">
                            <label data-i18n="endTime">End Time</label>
                            <input type="datetime-local" id="gb-record-end">
                        </div>
                        <div class="search-form-group" style="flex: 0.5; min-width: 100px;">
                            <label data-i18n="type">Type</label>
                            <select id="gb-record-type">
                                <option value="all" data-i18n="typeAll">All</option>
                                <option value="time" data-i18n="typeTime">Time</option>
                                <option value="alarm" data-i18n="typeAlarm">Alarm</option>
                                <option value="manual" data-i18n="typeManual">Manual</option>
                            </select>
                        </div>
                        <button class="search-btn" onclick="searchGbRecords()" data-i18n="search">Search</button>
                    </div>
                </div>
                <div id="gb-record-content" class="data-table">
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                        <p data-i18n="searchRecordsHint">Select a device and time range to search records</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- WebRTC Section -->
        <div id="webrtc-section" class="content-section">
            <div class="content-header">
                <h1 data-i18n="webrtcSessionList">WebRTC Session List</h1>
                <button class="refresh-btn" onclick="loadWebRTCSessions()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    <span data-i18n="refresh">Refresh</span>
                </button>
            </div>
            <div id="webrtc-content" class="data-table">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Video Modal -->
    <div id="video-modal" class="video-modal">
        <div class="video-container">
            <div class="video-header">
                <h3 id="video-title">Device Preview</h3>
                <button class="close-btn" onclick="closeVideoModal()">&times;</button>
            </div>
            <video id="video-player" controls autoplay></video>
            <div id="video-loading" class="video-loading" style="display: none;">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <!-- Add Device Modal -->
    <div id="add-device-modal" class="form-modal">
        <div class="form-container">
            <div class="form-header">
                <h3 data-i18n="addDevice">Add Device</h3>
                <button class="close-btn" onclick="closeAddDeviceModal()">&times;</button>
            </div>
            <div class="form-body">
                <div class="form-group">
                    <label><span data-i18n="protocol">Protocol</span> <span class="required">*</span></label>
                    <select id="device-protocol" onchange="onProtocolChange()">
                        <option value="2">RTSP</option>
                        <option value="4">ONVIF</option>
                    </select>
                </div>
                <div class="form-group">
                    <label><span data-i18n="name">Name</span> <span class="required">*</span></label>
                    <input type="text" id="device-name" data-i18n-placeholder="enterDeviceName"
                        placeholder="Enter device name">
                </div>
                <div class="form-group" id="url-group">
                    <label>URL <span class="required">*</span></label>
                    <input type="text" id="device-url" placeholder="rtsp://user:pass@ip:port/path">
                </div>
                <div class="form-group" id="ipaddr-group" style="display: none;">
                    <label><span data-i18n="ipAddress">IP Address</span> <span class="required">*</span></label>
                    <input type="text" id="device-ipaddr" placeholder="192.168.1.100">
                </div>
                <div class="form-group" id="user-group" style="display: none;">
                    <label><span data-i18n="username">Username</span> <span class="required">*</span></label>
                    <input type="text" id="device-user" placeholder="admin">
                </div>
                <div class="form-group" id="pass-group" style="display: none;">
                    <label><span data-i18n="password">Password</span> <span class="required">*</span></label>
                    <input type="password" id="device-pass" data-i18n-placeholder="enterPassword"
                        placeholder="Enter password">
                </div>
            </div>
            <div class="form-footer">
                <button class="btn-cancel" onclick="closeAddDeviceModal()" data-i18n="cancel">Cancel</button>
                <button class="btn-submit" onclick="submitAddDevice()" data-i18n="add">Add</button>
            </div>
        </div>
    </div>

    <script>
        // API Base URL
        const API_BASE_URL = 'https://192.168.3.211:26080';

        // Current language
        let currentLang = localStorage.getItem('lang') || 'en';

        // Translations
        const translations = {
            en: {
                // Navigation
                mediaServer: 'Media Server',
                navDevice: 'Device',
                navFile: 'File',
                navGbDomain: 'GB Domain',
                navWebrtc: 'WebRTC',

                // Device section
                deviceList: 'Device List',
                addDevice: 'Add Device',
                refresh: 'Refresh',
                noDevicesFound: 'No devices found',

                // File section
                fileList: 'File List',
                upload: 'Upload',
                noFilesFound: 'No files found',

                // GB Domain section
                domainList: 'Domain List',
                gbRecord: 'GB Record',
                catalog: 'Catalog',
                serverInfo: 'Server Info',
                noGbDomainsFound: 'No GB domains found',

                // GB Record
                gbDevice: 'GB Device',
                selectDevice: '-- Select Device --',
                startTime: 'Start Time',
                endTime: 'End Time',
                type: 'Type',
                typeAll: 'All',
                typeTime: 'Time',
                typeAlarm: 'Alarm',
                typeManual: 'Manual',
                search: 'Search',
                searchRecordsHint: 'Select a device and time range to search records',
                noRecordsFound: 'No records found for the selected time range',

                // WebRTC section
                webrtcSessionList: 'WebRTC Session List',
                noSessionsFound: 'No WebRTC sessions found',

                // Add Device Modal
                protocol: 'Protocol',
                name: 'Name',
                ipAddress: 'IP Address',
                username: 'Username',
                password: 'Password',
                enterDeviceName: 'Enter device name',
                enterPassword: 'Enter password',
                cancel: 'Cancel',
                add: 'Add',

                // Table headers
                deviceId: 'Device ID',
                status: 'Status',
                codec: 'Codec',
                resolution: 'Resolution',
                action: 'Action',
                fileId: 'File ID',
                fileName: 'File Name',
                size: 'Size',
                duration: 'Duration',
                frameRate: 'Frame Rate',
                domainId: 'Domain ID',
                deviceCount: 'Device Count',
                ip: 'IP',
                port: 'Port',
                sessionId: 'Session ID',
                videoCodec: 'Video Codec',
                audioCodec: 'Audio Codec',

                // Messages
                confirmDeleteDevice: 'Are you sure you want to delete',
                confirmDeleteFile: 'Are you sure you want to delete',
                deviceDeletedSuccess: 'Device deleted successfully',
                fileDeletedSuccess: 'File deleted successfully',
                deviceAddedSuccess: 'Device added successfully',
                uploadSuccess: 'Upload successful',
                uploadFailed: 'Upload failed',
                deleteFailed: 'Delete failed',
                addFailed: 'Failed to add device',
                nameRequired: 'Name is required',
                urlRequired: 'URL is required',
                ipRequired: 'IP Address is required',
                usernameRequired: 'Username is required',
                passwordRequired: 'Password is required',
                selectDeviceAlert: 'Please select a device',
                selectStartTime: 'Please select start time',
                selectEndTime: 'Please select end time',
                endTimeAfterStart: 'End time must be after start time',
                timeRangeLimit: 'Time range must be less than or equal to 1 hour',
                catalogSyncSuccess: 'Catalog sync initiated successfully',
                catalogSyncFailed: 'Catalog sync failed',
                failedToGetDeviceUrl: 'Failed to get device URL',
                failedToGetFileUrl: 'Failed to get file URL',
                failedToGetRecordUrl: 'Failed to get record URL',
                failedToGetServerInfo: 'Failed to get server info',
                browserNotSupported: 'Your browser does not support mpegts.js',

                // GB Server Info
                gbServerInfo: 'GB Server Information',
                rtpTransport: 'RTP Transport',

                // Record types display
                recordTypeTime: 'Time (Scheduled)',
                recordTypeAlarm: 'Alarm',
                recordTypeManual: 'Manual',

                // Uploading
                uploading: 'Uploading'
            },
            zh: {
                // Navigation
                mediaServer: '媒体服务器',
                navDevice: '设备',
                navFile: '文件',
                navGbDomain: '国标域',
                navWebrtc: 'WebRTC',

                // Device section
                deviceList: '设备列表',
                addDevice: '添加设备',
                refresh: '刷新',
                noDevicesFound: '暂无设备',

                // File section
                fileList: '文件列表',
                upload: '上传',
                noFilesFound: '暂无文件',

                // GB Domain section
                domainList: '域列表',
                gbRecord: '录像查询',
                catalog: '目录同步',
                serverInfo: '服务器信息',
                noGbDomainsFound: '暂无国标域',

                // GB Record
                gbDevice: '国标设备',
                selectDevice: '-- 请选择设备 --',
                startTime: '开始时间',
                endTime: '结束时间',
                type: '类型',
                typeAll: '全部',
                typeTime: '定时',
                typeAlarm: '告警',
                typeManual: '手动',
                search: '搜索',
                searchRecordsHint: '请选择设备和时间范围搜索录像',
                noRecordsFound: '所选时间范围内未找到录像',

                // WebRTC section
                webrtcSessionList: 'WebRTC 会话列表',
                noSessionsFound: '暂无 WebRTC 会话',

                // Add Device Modal
                protocol: '协议',
                name: '名称',
                ipAddress: 'IP 地址',
                username: '用户名',
                password: '密码',
                enterDeviceName: '请输入设备名称',
                enterPassword: '请输入密码',
                cancel: '取消',
                add: '添加',

                // Table headers
                deviceId: '设备ID',
                status: '状态',
                codec: '编码',
                resolution: '分辨率',
                action: '操作',
                fileId: '文件ID',
                fileName: '文件名',
                size: '大小',
                duration: '时长',
                frameRate: '帧率',
                domainId: '域ID',
                deviceCount: '设备数',
                ip: 'IP',
                port: '端口',
                sessionId: '会话ID',
                videoCodec: '视频编码',
                audioCodec: '音频编码',

                // Messages
                confirmDeleteDevice: '确定要删除',
                confirmDeleteFile: '确定要删除',
                deviceDeletedSuccess: '设备删除成功',
                fileDeletedSuccess: '文件删除成功',
                deviceAddedSuccess: '设备添加成功',
                uploadSuccess: '上传成功',
                uploadFailed: '上传失败',
                deleteFailed: '删除失败',
                addFailed: '添加设备失败',
                nameRequired: '请输入名称',
                urlRequired: '请输入URL',
                ipRequired: '请输入IP地址',
                usernameRequired: '请输入用户名',
                passwordRequired: '请输入密码',
                selectDeviceAlert: '请选择设备',
                selectStartTime: '请选择开始时间',
                selectEndTime: '请选择结束时间',
                endTimeAfterStart: '结束时间必须晚于开始时间',
                timeRangeLimit: '时间范围不能超过1小时',
                catalogSyncSuccess: '目录同步已启动',
                catalogSyncFailed: '目录同步失败',
                failedToGetDeviceUrl: '获取设备URL失败',
                failedToGetFileUrl: '获取文件URL失败',
                failedToGetRecordUrl: '获取录像URL失败',
                failedToGetServerInfo: '获取服务器信息失败',
                browserNotSupported: '您的浏览器不支持 mpegts.js',

                // GB Server Info
                gbServerInfo: '国标服务器信息',
                rtpTransport: 'RTP传输方式',

                // Record types display
                recordTypeTime: '定时录像',
                recordTypeAlarm: '告警录像',
                recordTypeManual: '手动录像',

                // Uploading
                uploading: '正在上传'
            }
        };

        // Get translation
        function t(key) {
            return translations[currentLang][key] || translations['en'][key] || key;
        }

        // Apply translations to page
        function applyTranslations() {
            // Update elements with data-i18n
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[currentLang][key]) {
                    el.textContent = translations[currentLang][key];
                }
            });

            // Update placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (translations[currentLang][key]) {
                    el.placeholder = translations[currentLang][key];
                }
            });

            // Update page title
            document.title = t('mediaServer');
        }

        // Switch language
        function switchLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('lang', lang);

            // Update button states
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-lang') === lang);
            });

            applyTranslations();

            // Reload current section data to update dynamic content
            const activeNav = document.querySelector('.nav-item.active');
            if (activeNav) {
                const target = activeNav.getAttribute('data-target');
                if (target === 'device') loadDevices();
                else if (target === 'file') loadFiles();
                else if (target === 'gbdomain') loadGbDomains();
                else if (target === 'webrtc') loadWebRTCSessions();
            }
        }

        // Language switcher event
        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                switchLanguage(this.getAttribute('data-lang'));
            });
        });

        // Protocol enum mapping
        const PROTOCOL_MAP = {
            1: 'GB28181',
            2: 'RTSP',
            3: 'RTMP',
            4: 'ONVIF'
        };

        function getProtocolName(protocol) {
            return PROTOCOL_MAP[protocol] || '-';
        }

        // Navigation handling
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function () {
                // Update active nav item
                document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                this.classList.add('active');

                // Show corresponding section
                const target = this.getAttribute('data-target');
                document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
                document.getElementById(`${target}-section`).classList.add('active');

                // Load data
                if (target === 'device') {
                    loadDevices();
                } else if (target === 'file') {
                    loadFiles();
                } else if (target === 'gbdomain') {
                    loadGbDomains();
                } else if (target === 'webrtc') {
                    loadWebRTCSessions();
                }
            });
        });

        // Show Add Device Modal
        function showAddDeviceModal() {
            document.getElementById('add-device-modal').classList.add('active');
            // Reset form
            document.getElementById('device-protocol').value = '2';
            document.getElementById('device-name').value = '';
            document.getElementById('device-url').value = '';
            document.getElementById('device-ipaddr').value = '';
            document.getElementById('device-user').value = '';
            document.getElementById('device-pass').value = '';
            onProtocolChange();
        }

        // Close Add Device Modal
        function closeAddDeviceModal() {
            document.getElementById('add-device-modal').classList.remove('active');
        }

        // Handle protocol change
        function onProtocolChange() {
            const protocol = document.getElementById('device-protocol').value;
            const urlGroup = document.getElementById('url-group');
            const ipaddrGroup = document.getElementById('ipaddr-group');
            const userGroup = document.getElementById('user-group');
            const passGroup = document.getElementById('pass-group');

            if (protocol === '2') {
                // RTSP: show URL, hide ipAddr/user/pass
                urlGroup.style.display = 'block';
                ipaddrGroup.style.display = 'none';
                userGroup.style.display = 'none';
                passGroup.style.display = 'none';
            } else if (protocol === '4') {
                // ONVIF: hide URL, show ipAddr/user/pass
                urlGroup.style.display = 'none';
                ipaddrGroup.style.display = 'block';
                userGroup.style.display = 'block';
                passGroup.style.display = 'block';
            }
        }

        // Submit Add Device
        async function submitAddDevice() {
            const protocol = parseInt(document.getElementById('device-protocol').value);
            const name = document.getElementById('device-name').value.trim();
            const url = document.getElementById('device-url').value.trim();
            const ipAddr = document.getElementById('device-ipaddr').value.trim();
            const user = document.getElementById('device-user').value.trim();
            const pass = document.getElementById('device-pass').value.trim();

            // Validate based on protocol
            if (protocol === 2) {
                // RTSP: name and url required
                if (!name) {
                    alert(t('nameRequired'));
                    return;
                }
                if (!url) {
                    alert(t('urlRequired'));
                    return;
                }
            } else if (protocol === 4) {
                // ONVIF: name, ipAddr, user, pass required
                if (!name) {
                    alert(t('nameRequired'));
                    return;
                }
                if (!ipAddr) {
                    alert(t('ipRequired'));
                    return;
                }
                if (!user) {
                    alert(t('usernameRequired'));
                    return;
                }
                if (!pass) {
                    alert(t('passwordRequired'));
                    return;
                }
            }

            // Build request body
            const body = {
                protocol: protocol,
                name: name
            };

            if (protocol === 2) {
                body.url = url;
            } else if (protocol === 4) {
                body.ipAddr = ipAddr;
                body.user = user;
                body.pass = pass;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/device`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                const data = await response.json();

                if (data.code === 0) {
                    alert(t('deviceAddedSuccess'));
                    closeAddDeviceModal();
                    loadDevices();
                } else {
                    alert(t('addFailed') + ': ' + (data.msg || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Close modal on background click
        document.getElementById('add-device-modal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeAddDeviceModal();
            }
        });

        // Load devices from API
        async function loadDevices() {
            const container = document.getElementById('device-content');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const response = await fetch(`${API_BASE_URL}/device`);
                const data = await response.json();

                if (data.code === 0 && data.result && data.result.length > 0) {
                    let html = `
                        <table>
                            <thead>
                                <tr>
                                    <th>${t('deviceId')}</th>
                                    <th>${t('name')}</th>
                                    <th>${t('protocol')}</th>
                                    <th>${t('type')}</th>
                                    <th>${t('status')}</th>
                                    <th>${t('codec')}</th>
                                    <th>${t('resolution')}</th>
                                    <th>${t('action')}</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    data.result.forEach(device => {
                        const statusClass = device.status === 'ON' ? 'status-on' : 'status-off';
                        html += `
                            <tr>
                                <td>${device.deviceId || '-'}</td>
                                <td>${device.name || '-'}</td>
                                <td>${getProtocolName(device.protocol)}</td>
                                <td>${device.type || '-'}</td>
                                <td><span class="status-badge ${statusClass}">${device.status || '-'}</span></td>
                                <td>${device.codec || '-'}</td>
                                <td>${device.resolution || '-'}</td>
                                <td>
                                    <span class="preview-icon" onclick="previewDevice('${device.deviceId}', '${device.name || 'Device Preview'}')" title="Preview">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    </span>
                                    <span class="delete-icon" onclick="deleteDevice('${device.deviceId}', '${device.name || 'this device'}')" title="Delete">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </span>
                                </td>
                            </tr>
                        `;
                    });

                    html += '</tbody></table>';
                    container.innerHTML = html;
                } else if (data.code === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                            </svg>
                            <p>${t('noDevicesFound')}</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = `<div class="error-message">Error: ${data.msg || 'Failed to load devices'}</div>`;
                }
            } catch (error) {
                container.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
            }
        }

        // Delete device
        async function deleteDevice(deviceId, deviceName) {
            if (!confirm(`${t('confirmDeleteDevice')} "${deviceName}"?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/device`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ device: [deviceId] })
                });
                const data = await response.json();

                if (data.code === 0) {
                    alert(t('deviceDeletedSuccess'));
                    // Reload device list
                    loadDevices();
                } else {
                    alert(t('deleteFailed') + ': ' + (data.msg || 'Unknown error'));
                }
            } catch (error) {
                alert(t('deleteFailed') + ': ' + error.message);
            }
        }

        // Upload file
        async function uploadFile(input) {
            if (!input.files || input.files.length === 0) {
                return;
            }

            const file = input.files[0];
            const formData = new FormData();
            formData.append('file', file);

            // Show loading state
            const container = document.getElementById('file-content');
            const originalContent = container.innerHTML;
            container.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p style="margin-top: 15px; color: #6c757d;">${t('uploading')} ${file.name}...</p>
                </div>
            `;

            try {
                const response = await fetch(`${API_BASE_URL}/file/upload`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.code === 0) {
                    alert(t('uploadSuccess') + ': ' + (data.msg || file.name));
                    // Reload file list
                    loadFiles();
                } else {
                    alert(t('uploadFailed') + ': ' + (data.msg || 'Unknown error'));
                    container.innerHTML = originalContent;
                }
            } catch (error) {
                alert(t('uploadFailed') + ': ' + error.message);
                container.innerHTML = originalContent;
            } finally {
                // Reset file input
                input.value = '';
            }
        }

        // Delete file
        async function deleteFile(fileId, fileName) {
            if (!confirm(`${t('confirmDeleteFile')} "${fileName}"?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/file`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ fileId: Number(fileId) })
                });
                const data = await response.json();

                if (data.code === 0) {
                    alert(t('fileDeletedSuccess'));
                    // Reload file list
                    loadFiles();
                } else {
                    alert(t('deleteFailed') + ': ' + (data.msg || 'Unknown error'));
                }
            } catch (error) {
                alert(t('deleteFailed') + ': ' + error.message);
            }
        }

        // Load files from API
        async function loadFiles() {
            const container = document.getElementById('file-content');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const response = await fetch(`${API_BASE_URL}/file`);
                const data = await response.json();

                if (data.code === 0 && data.result && data.result.length > 0) {
                    let html = `
                        <table>
                            <thead>
                                <tr>
                                    <th>${t('fileId')}</th>
                                    <th>${t('fileName')}</th>
                                    <th>${t('size')}</th>
                                    <th>${t('codec')}</th>
                                    <th>${t('resolution')}</th>
                                    <th>${t('duration')}</th>
                                    <th>${t('frameRate')}</th>
                                    <th>${t('action')}</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    data.result.forEach(file => {
                        const sizeStr = formatFileSize(file.size);
                        const durationStr = formatDuration(file.duration);
                        html += `
                            <tr>
                                <td>${file.fileId || '-'}</td>
                                <td>${file.fileName || '-'}</td>
                                <td>${sizeStr}</td>
                                <td>${file.codec || '-'}</td>
                                <td>${file.resolution || '-'}</td>
                                <td>${durationStr}</td>
                                <td>${file.frameRate ? file.frameRate.toFixed(1) + ' fps' : '-'}</td>
                                <td>
                                    <span class="preview-icon" onclick="previewFile('${file.fileId}', '${file.fileName || 'File Preview'}')" title="Preview">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    </span>
                                    <span class="delete-icon" onclick="deleteFile('${file.fileId}', '${file.fileName || 'this file'}')" title="Delete">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </span>
                                </td>
                            </tr>
                        `;
                    });

                    html += '</tbody></table>';
                    container.innerHTML = html;
                } else if (data.code === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                            </svg>
                            <p>${t('noFilesFound')}</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = `<div class="error-message">Error: ${data.msg || 'Failed to load files'}</div>`;
                }
            } catch (error) {
                container.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
            }
        }

        // Load GB Domains from API
        async function loadGbDomains() {
            const container = document.getElementById('gbdomain-content');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const response = await fetch(`${API_BASE_URL}/gb/domain`);
                const data = await response.json();

                if (data.code === 0 && data.result && data.result.length > 0) {
                    let html = `
                        <table>
                            <thead>
                                <tr>
                                    <th>${t('domainId')}</th>
                                    <th>${t('deviceCount')}</th>
                                    <th>${t('ip')}</th>
                                    <th>${t('port')}</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    data.result.forEach(domain => {
                        html += `
                            <tr>
                                <td>${domain.id || '-'}</td>
                                <td>${domain.devNum || 0}</td>
                                <td>${domain.ip || '-'}</td>
                                <td>${domain.port || '-'}</td>
                            </tr>
                        `;
                    });

                    html += '</tbody></table>';
                    container.innerHTML = html;
                } else if (data.code === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                            </svg>
                            <p>${t('noGbDomainsFound')}</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = `<div class="error-message">Error: ${data.msg || 'Failed to load GB domains'}</div>`;
                }
            } catch (error) {
                container.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
            }
        }

        // Sync GB Catalog
        async function syncGbCatalog() {
            try {
                const response = await fetch(`${API_BASE_URL}/gb/catalog`);
                const data = await response.json();

                if (data.code === 0) {
                    alert(t('catalogSyncSuccess'));
                    // Reload domains and devices
                    loadGbDomains();
                    loadDevices();
                } else {
                    alert(t('catalogSyncFailed') + ': ' + (data.msg || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Show GB Server Info
        async function showGbServerInfo() {
            try {
                const response = await fetch(`${API_BASE_URL}/gb/server`);
                const data = await response.json();

                if (data.code === 0 && data.result) {
                    const info = data.result;
                    const rtpTransportMap = {
                        0: 'UDP',
                        1: 'TCP Active',
                        2: 'TCP Passive'
                    };
                    const rtpTransport = rtpTransportMap[info.rtpTransport] || info.rtpTransport;

                    alert(
                        `${t('gbServerInfo')}:\n\n` +
                        `ID: ${info.id || '-'}\n` +
                        `IP: ${info.ip || '-'}\n` +
                        `${t('port')}: ${info.port || '-'}\n` +
                        `${t('password')}: ${info.pass || '-'}\n` +
                        `${t('rtpTransport')}: ${rtpTransport}`
                    );
                } else {
                    alert(t('failedToGetServerInfo') + ': ' + (data.msg || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // GB Tabs navigation
        document.querySelectorAll('.gb-tab').forEach(tab => {
            tab.addEventListener('click', function () {
                // Update active tab
                document.querySelectorAll('.gb-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');

                // Show corresponding content
                const target = this.getAttribute('data-gb-target');
                document.querySelectorAll('.gb-tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(target).classList.add('active');

                // Load GB devices when switching to record tab
                if (target === 'gb-record-tab') {
                    loadGbDevicesForRecord();
                }
            });
        });

        // Cached GB devices list
        let cachedGbDevices = [];

        // Load GB devices (protocol==1 and type=='camera') for record search
        async function loadGbDevicesForRecord() {
            const select = document.getElementById('gb-record-device');

            try {
                const response = await fetch(`${API_BASE_URL}/device`);
                const data = await response.json();

                if (data.code === 0 && data.result) {
                    // Filter GB devices (protocol==1) with type=='camera'
                    cachedGbDevices = data.result.filter(d => d.protocol === 1 && d.type === 'camera');

                    // Populate select
                    let options = `<option value="">${t('selectDevice')}</option>`;
                    cachedGbDevices.forEach(device => {
                        const displayName = device.name ? `${device.name} (${device.deviceId})` : device.deviceId;
                        options += `<option value="${device.deviceId}">${displayName}</option>`;
                    });
                    select.innerHTML = options;
                }
            } catch (error) {
                console.error('Error loading GB devices:', error);
            }
        }

        // Get record type display name
        function getRecordTypeName(type) {
            const map = {
                'time': t('recordTypeTime'),
                'alarm': t('recordTypeAlarm'),
                'manual': t('recordTypeManual'),
                'all': t('typeAll')
            };
            return map[type] || type || '-';
        }

        // Record type mapping (deprecated, use getRecordTypeName)
        const RECORD_TYPE_MAP = {
            'time': 'Time (Scheduled)',
            'alarm': 'Alarm',
            'manual': 'Manual',
            'all': 'All'
        };

        // Search GB Records
        async function searchGbRecords() {
            const deviceId = document.getElementById('gb-record-device').value;
            const startTime = document.getElementById('gb-record-start').value;
            const endTime = document.getElementById('gb-record-end').value;
            const type = document.getElementById('gb-record-type').value;
            const container = document.getElementById('gb-record-content');

            // Validate inputs
            if (!deviceId) {
                alert(t('selectDeviceAlert'));
                return;
            }
            if (!startTime) {
                alert(t('selectStartTime'));
                return;
            }
            if (!endTime) {
                alert(t('selectEndTime'));
                return;
            }

            // Validate time range (<= 1 hour)
            const start = new Date(startTime);
            const end = new Date(endTime);
            const diffMs = end - start;
            const diffHours = diffMs / (1000 * 60 * 60);

            if (diffMs <= 0) {
                alert(t('endTimeAfterStart'));
                return;
            }
            if (diffHours > 1) {
                alert(t('timeRangeLimit'));
                return;
            }

            // Show loading
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                // Format times for API (ISO 8601)
                const formatDateTime = (dt) => {
                    return dt.replace('T', 'T') + ':00';
                };

                const body = {
                    deviceId: deviceId,
                    startTime: formatDateTime(startTime),
                    endTime: formatDateTime(endTime),
                    type: type
                };

                const response = await fetch(`${API_BASE_URL}/gb/record`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                const data = await response.json();

                if (data.code === 0 && data.result && data.result.length > 0) {
                    let html = `
                        <table>
                            <thead>
                                <tr>
                                    <th>${t('deviceId')}</th>
                                    <th>${t('name')}</th>
                                    <th>${t('startTime')}</th>
                                    <th>${t('endTime')}</th>
                                    <th>${t('type')}</th>
                                    <th>${t('action')}</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    data.result.forEach(record => {
                        const recordType = getRecordTypeName(record.type);
                        html += `
                            <tr>
                                <td>${record.deviceId || '-'}</td>
                                <td>${record.name || '-'}</td>
                                <td>${record.startTime || '-'}</td>
                                <td>${record.endTime || '-'}</td>
                                <td>${recordType}</td>
                                <td>
                                    <span class="preview-icon" onclick="playGbRecord('${record.deviceId}', '${record.startTime}', '${record.endTime}', '${record.type || 'time'}')" title="Play">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    </span>
                                </td>
                            </tr>
                        `;
                    });

                    html += '</tbody></table>';
                    container.innerHTML = html;
                } else if (data.code === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                            <p>${t('noRecordsFound')}</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = `<div class="error-message">Error: ${data.msg || 'Failed to search records'}</div>`;
                }
            } catch (error) {
                container.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
            }
        }

        // Play GB Record
        async function playGbRecord(deviceId, startTime, endTime, type) {
            const modal = document.getElementById('video-modal');
            const videoElement = document.getElementById('video-player');
            const videoTitle = document.getElementById('video-title');
            const videoLoading = document.getElementById('video-loading');

            // Show modal and loading
            modal.classList.add('active');
            videoTitle.textContent = `Record: ${startTime} - ${endTime}`;
            videoLoading.style.display = 'block';

            try {
                // Get record playback URL
                const body = {
                    deviceId: deviceId,
                    startTime: startTime,
                    endTime: endTime,
                    type: type
                };

                const response = await fetch(`${API_BASE_URL}/gb/record/url`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                const data = await response.json();

                if (data.code === 0 && data.result && data.result.httpFlvUrl) {
                    const flvUrl = data.result.httpFlvUrl;

                    // Destroy existing player if any
                    if (mpegtsPlayer) {
                        mpegtsPlayer.destroy();
                        mpegtsPlayer = null;
                    }

                    // Check if mpegts.js is supported
                    if (mpegts.isSupported()) {
                        mpegtsPlayer = mpegts.createPlayer({
                            type: 'flv',
                            url: flvUrl,
                            isLive: true
                        });
                        mpegtsPlayer.attachMediaElement(videoElement);
                        mpegtsPlayer.load();
                        mpegtsPlayer.play();
                    } else {
                        alert(t('browserNotSupported'));
                        closeVideoModal();
                    }
                } else {
                    alert(t('failedToGetRecordUrl') + ': ' + (data.msg || 'Unknown error'));
                    closeVideoModal();
                }
            } catch (error) {
                alert('Error: ' + error.message);
                closeVideoModal();
            } finally {
                videoLoading.style.display = 'none';
            }
        }

        // Video player instance
        let mpegtsPlayer = null;

        // Preview device stream
        async function previewDevice(deviceId, deviceName) {
            const modal = document.getElementById('video-modal');
            const videoElement = document.getElementById('video-player');
            const videoTitle = document.getElementById('video-title');
            const videoLoading = document.getElementById('video-loading');

            // Show modal and loading
            modal.classList.add('active');
            videoTitle.textContent = deviceName;
            videoLoading.style.display = 'block';

            try {
                // Get device URL
                const response = await fetch(`${API_BASE_URL}/device/url?deviceId=${encodeURIComponent(deviceId)}`);
                const data = await response.json();

                if (data.code === 0 && data.result && data.result.rtcUrl) {
                    const whepUrl = data.result.rtcUrl;

                    // Close existing peer connection if any
                    if (whepPeerConnection) {
                        whepPeerConnection.close();
                        whepPeerConnection = null;
                    }

                    // Create WHEP connection
                    await startWhepPlayer(whepUrl, videoElement);
                } else {
                    alert(t('failedToGetDeviceUrl') + ': ' + (data.msg || 'Unknown error'));
                    closeVideoModal();
                }
            } catch (error) {
                alert('Error: ' + error.message);
                closeVideoModal();
            } finally {
                videoLoading.style.display = 'none';
            }
        }

        // Close video modal
        function closeVideoModal() {
            const modal = document.getElementById('video-modal');
            modal.classList.remove('active');

            // Destroy player
            if (mpegtsPlayer) {
                mpegtsPlayer.destroy();
                mpegtsPlayer = null;
            }
        }

        // Close modal on background click
        document.getElementById('video-modal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeVideoModal();
            }
        });

        // Preview file stream
        async function previewFile(fileId, fileName) {
            const modal = document.getElementById('video-modal');
            const videoElement = document.getElementById('video-player');
            const videoTitle = document.getElementById('video-title');
            const videoLoading = document.getElementById('video-loading');

            // Show modal and loading
            modal.classList.add('active');
            videoTitle.textContent = fileName;
            videoLoading.style.display = 'block';

            try {
                // Get file URL
                const response = await fetch(`${API_BASE_URL}/file/url?fileId=${encodeURIComponent(fileId)}`);
                const data = await response.json();

                if (data.code === 0 && data.result && data.result.httpFlvUrl) {
                    const flvUrl = data.result.httpFlvUrl;

                    // Destroy existing player if any
                    if (mpegtsPlayer) {
                        mpegtsPlayer.destroy();
                        mpegtsPlayer = null;
                    }

                    // Check if mpegts.js is supported
                    if (mpegts.isSupported()) {
                        mpegtsPlayer = mpegts.createPlayer({
                            type: 'flv',
                            url: flvUrl,
                            isLive: true
                        });
                        mpegtsPlayer.attachMediaElement(videoElement);
                        mpegtsPlayer.load();
                        mpegtsPlayer.play();
                    } else {
                        alert(t('browserNotSupported'));
                        closeVideoModal();
                    }
                } else {
                    alert(t('failedToGetFileUrl') + ': ' + (data.msg || 'Unknown error'));
                    closeVideoModal();
                }
            } catch (error) {
                alert('Error: ' + error.message);
                closeVideoModal();
            } finally {
                videoLoading.style.display = 'none';
            }
        }

        // Load WebRTC sessions from API
        async function loadWebRTCSessions() {
            const container = document.getElementById('webrtc-content');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const response = await fetch(`${API_BASE_URL}/rtc/session`);
                const data = await response.json();

                if (data.code === 0 && data.result && data.result.length > 0) {
                    let html = `
                        <table>
                            <thead>
                                <tr>
                                    <th>${t('sessionId')}</th>
                                    <th>${t('videoCodec')}</th>
                                    <th>${t('audioCodec')}</th>
                                    <th>${t('action')}</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    data.result.forEach(session => {
                        html += `
                            <tr>
                                <td>${session.sessionId || '-'}</td>
                                <td>${session.videoCodec || '-'}</td>
                                <td>${session.audioCodec || '-'}</td>
                                <td>
                                    <span class="preview-icon" onclick="previewWebRTC('${session.sessionId}', 'Session ${session.sessionId || ''}')" title="Preview">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    </span>
                                </td>
                            </tr>
                        `;
                    });

                    html += '</tbody></table>';
                    container.innerHTML = html;
                } else if (data.code === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0" />
                            </svg>
                            <p>${t('noSessionsFound')}</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = `<div class="error-message">Error: ${data.msg || 'Failed to load WebRTC sessions'}</div>`;
                }
            } catch (error) {
                container.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
            }
        }

        // WebRTC peer connection
        let whepPeerConnection = null;

        // Preview WebRTC stream using WHEP
        async function previewWebRTC(sessionId, sessionName) {
            const modal = document.getElementById('video-modal');
            const videoElement = document.getElementById('video-player');
            const videoTitle = document.getElementById('video-title');
            const videoLoading = document.getElementById('video-loading');

            // Show modal and loading
            modal.classList.add('active');
            videoTitle.textContent = sessionName;
            videoLoading.style.display = 'block';

            try {
                // Get WebRTC session URL
                const response = await fetch(`${API_BASE_URL}/rtc/session/url?sessionId=${encodeURIComponent(sessionId)}`);
                const data = await response.json();

                if (data.code === 0 && data.result && data.result.rtcUrl) {
                    const whepUrl = data.result.rtcUrl;

                    // Close existing peer connection if any
                    if (whepPeerConnection) {
                        whepPeerConnection.close();
                        whepPeerConnection = null;
                    }

                    // Create WHEP connection
                    await startWhepPlayer(whepUrl, videoElement);
                } else {
                    alert('Failed to get WebRTC URL: ' + (data.msg || 'Unknown error'));
                    closeVideoModal();
                }
            } catch (error) {
                alert('Error: ' + error.message);
                closeVideoModal();
            } finally {
                videoLoading.style.display = 'none';
            }
        }

        // WHEP Player implementation
        async function startWhepPlayer(whepUrl, videoElement) {
            // Create peer connection
            whepPeerConnection = new RTCPeerConnection({
                //iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
            });

            // Handle incoming tracks
            whepPeerConnection.ontrack = (event) => {
                if (event.streams && event.streams[0]) {
                    videoElement.srcObject = event.streams[0];
                }
            };

            // Add transceivers for receiving audio and video
            whepPeerConnection.addTransceiver('video', { direction: 'recvonly' });
            whepPeerConnection.addTransceiver('audio', { direction: 'recvonly' });

            // Create offer
            const offer = await whepPeerConnection.createOffer();
            await whepPeerConnection.setLocalDescription(offer);

            // Wait for ICE gathering to complete
            await new Promise((resolve) => {
                if (whepPeerConnection.iceGatheringState === 'complete') {
                    resolve();
                } else {
                    const checkState = () => {
                        if (whepPeerConnection.iceGatheringState === 'complete') {
                            whepPeerConnection.removeEventListener('icegatheringstatechange', checkState);
                            resolve();
                        }
                    };
                    whepPeerConnection.addEventListener('icegatheringstatechange', checkState);
                }
            });

            // Send offer to WHEP endpoint
            const whepResponse = await fetch(whepUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/sdp'
                },
                body: whepPeerConnection.localDescription.sdp
            });

            if (!whepResponse.ok) {
                throw new Error('WHEP request failed: ' + whepResponse.statusText);
            }

            // Get answer SDP
            const answerSdp = await whepResponse.text();
            await whepPeerConnection.setRemoteDescription({
                type: 'answer',
                sdp: answerSdp
            });
        }

        // Update closeVideoModal to also close WHEP connection
        const originalCloseVideoModal = closeVideoModal;
        closeVideoModal = function () {
            // Close WHEP peer connection
            if (whepPeerConnection) {
                whepPeerConnection.close();
                whepPeerConnection = null;
            }
            // Clear video srcObject for WebRTC
            const videoElement = document.getElementById('video-player');
            if (videoElement.srcObject) {
                videoElement.srcObject = null;
            }
            originalCloseVideoModal();
        };

        // Format file size
        function formatFileSize(bytes) {
            if (!bytes) return '-';
            const units = ['B', 'KB', 'MB', 'GB', 'TB'];
            let i = 0;
            while (bytes >= 1024 && i < units.length - 1) {
                bytes /= 1024;
                i++;
            }
            return bytes.toFixed(2) + ' ' + units[i];
        }

        // Format duration
        function formatDuration(seconds) {
            if (!seconds) return '-';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);

            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }

        // Initial load
        document.addEventListener('DOMContentLoaded', function () {
            // Set initial language button state
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-lang') === currentLang);
            });

            // Apply translations
            applyTranslations();

            // Load initial data
            loadDevices();
        });
    </script>
</body>

</html>